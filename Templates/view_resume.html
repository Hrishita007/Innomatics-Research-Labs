{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-file-alt me-2"></i>{{ resume.original_name }}</h2>
            <div>
                <a href="{{ url_for('download_file', filename=resume.filename) }}" class="btn btn-primary">
                    <i class="fas fa-download me-2"></i>Download
                </a>
                <a href="{{ url_for('index') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>

        <div class="row">
            <!-- Resume Details -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle me-2"></i>Resume Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Original Name:</strong><br>
                            <span class="text-muted">{{ resume.original_name }}</span>
                        </div>
                        <div class="mb-3">
                            <strong>Upload Date:</strong><br>
                            <span class="text-muted">{{ resume.upload_date }}</span>
                        </div>
                        <div class="mb-3">
                            <strong>Section:</strong><br>
                            <span class="badge bg-primary">{{ resume.section }}</span>
                        </div>
                        <div class="mb-3">
                            <strong>Area:</strong><br>
                            <span class="badge bg-secondary">{{ resume.area }}</span>
                        </div>
                        {% if resume.notes %}
                        <div class="mb-3">
                            <strong>Notes:</strong><br>
                            <div class="text-muted">{{ resume.notes }}</div>
                        </div>
                        {% endif %}
                        
                        <!-- Edit Form -->
                        <hr>
                        <h6>Quick Edit</h6>
                        <form id="quickEditForm">
                            <div class="mb-2">
                                <select class="form-select form-select-sm" id="quickSection" onchange="updateQuickAreas()">
                                    {% for section in sections.keys() %}
                                    <option value="{{ section }}" {% if section == resume.section %}selected{% endif %}>
                                        {{ section }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-2">
                                <select class="form-select form-select-sm" id="quickArea">
                                </select>
                            </div>
                            <div class="mb-2">
                                <textarea class="form-control form-control-sm" id="quickNotes" rows="2" 
                                          placeholder="Notes...">{{ resume.notes or '' }}</textarea>
                            </div>
                            <button type="submit" class="btn btn-sm btn-success">
                                <i class="fas fa-save me-1"></i>Save Changes
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Resume Content -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-file-text me-2"></i>Resume Content</h5>
                    </div>
                    <div class="card-body">
                        {% if resume.full_text %}
                        <div style="max-height: 600px; overflow-y: auto; background-color: #f8f9fa; padding: 20px; border-radius: 5px;">
                            <pre style="white-space: pre-wrap; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 14px; line-height: 1.4;">{{ resume.full_text }}</pre>
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Unable to extract text content from this file. You can still download it using the button above.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const sections = {{ sections|tojson }};
const resumeId = {{ resume.id }};

function updateQuickAreas() {
    const section = document.getElementById('quickSection').value;
    const areaSelect = document.getElementById('quickArea');
    
    areaSelect.innerHTML = '';
    
    if (sections[section]) {
        sections[section].forEach(area => {
            const option = document.createElement('option');
            option.value = area;
            option.textContent = area;
            if (area === '{{ resume.area }}') {
                option.selected = true;
            }
            areaSelect.appendChild(option);
        });
    }
}

// Initialize areas on page load
updateQuickAreas();

document.getElementById('quickEditForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('section', document.getElementById('quickSection').value);
    formData.append('area', document.getElementById('quickArea').value);
    formData.append('notes', document.getElementById('quickNotes').value);
    
    fetch(`/update_resume/${resumeId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Resume updated successfully!');
            location.reload();
        }
    })
    .catch(error => {
        alert('Error updating resume!');
    });
});
</script>
{% endblock %}